Bootstrap: docker
From: nvidia/cuda:11.6.2-cudnn8-devel-ubuntu20.04

%files
requirements.txt /opt/requirements.txt

%post
chmod 444 /opt/requirements.txt
DEBIAN_FRONTEND="noninteractive" apt -y update
DEBIAN_FRONTEND="noninteractive" apt -y install software-properties-common
DEBIAN_FRONTEND="noninteractive" add-apt-repository ppa:deadsnakes/ppa
DEBIAN_FRONTEND="noninteractive" apt -y update
DEBIAN_FRONTEND="noninteractive" apt -y upgrade
DEBIAN_FRONTEND="noninteractive" apt -y install python3.10 python3.10-venv python3.10-dev git bash
DEBIAN_FRONTEND="noninteractive" apt -y autoremove
DEBIAN_FRONTEND="noninteractive" apt -y clean

# Configure virtualenv
mkdir -p /opt/closure_venv/
python3.10 -m venv --prompt=closure /opt/closure_venv/
cat /opt/closure_venv/bin/activate >> $SINGULARITY_ENVIRONMENT
/opt/closure_venv/bin/python -m pip install --compile --upgrade pip
/opt/closure_venv/bin/python -m pip install --compile --requirement /opt/requirements.txt
/opt/closure_venv/bin/python -m pip cache purge

%runscript
#! /bin/bash
exec "${@:-/bin/bash}"
