Bootstrap: docker
From: nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

%environment
export PIP_DISABLE_PIP_VERSION_CHECK=1

%files
requirements.txt /opt/requirements.txt
constraints.txt /opt/constraints.txt

%post
export DEBIAN_FRONTEND=noninteractive
chmod 444 /opt/requirements.txt
chmod 444 /opt/constraints.txt
apt-get -y update
apt-get -y install software-properties-common
add-apt-repository ppa:deadsnakes/ppa
apt-get -y update
apt-get -y upgrade
apt-get -y install python3.11 python3.11-venv python3.11-dev git bash
apt-get -y autoremove
apt-get -y clean

# Configure virtualenv
mkdir -p /opt/closure_venv/
python3.11 -m venv --prompt=closure /opt/closure_venv/
cat /opt/closure_venv/bin/activate >> "$SINGULARITY_ENVIRONMENT"
/opt/closure_venv/bin/python -m pip install --compile --upgrade pip
PIP_CONSTRAINT=/opt/constraints.txt /opt/closure_venv/bin/python -m pip install --compile --requirement /opt/requirements.txt
/opt/closure_venv/bin/python -m pip cache purge

%runscript
#! /bin/bash
exec "${@:-/bin/bash}"
