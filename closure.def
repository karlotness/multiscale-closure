Bootstrap: docker
From: nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04

%environment
export PIP_DISABLE_PIP_VERSION_CHECK=1

%files
requirements.txt /opt/requirements.txt

%post
export DEBIAN_FRONTEND=noninteractive
chmod 444 /opt/requirements.txt
apt-get -y update
apt-get -y install software-properties-common apt-transport-https ca-certificates gnupg curl
add-apt-repository ppa:deadsnakes/ppa
curl 'https://packages.cloud.google.com/apt/doc/apt-key.gpg' | gpg --dearmor -o '/usr/share/keyrings/cloud.google.gpg'
echo 'deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main' | tee -a '/etc/apt/sources.list.d/google-cloud-sdk.list'
apt-get -y update
apt-get -y install google-cloud-cli
apt-get -y install python3.12 python3.12-venv python3.12-dev git bash
apt-get -y upgrade
apt-get -y autoremove
apt-get -y clean

# Configure virtualenv
mkdir -p /opt/closure_venv/
python3.12 -m venv --prompt=closure /opt/closure_venv/
cat /opt/closure_venv/bin/activate >> "$SINGULARITY_ENVIRONMENT"
/opt/closure_venv/bin/python -m pip install --compile --upgrade pip
/opt/closure_venv/bin/python -m pip install --compile --requirement /opt/requirements.txt
/opt/closure_venv/bin/python -m pip cache purge

%runscript
#! /bin/bash
exec "${@:-/bin/bash}"
